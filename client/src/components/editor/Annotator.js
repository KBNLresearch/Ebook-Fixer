import { useEffect, useState } from 'react'
import PropTypes from 'prop-types'
import { ReactComponent as HistorySVG } from '../../assets/svgs/history-icon.svg'
import { ImageInfo } from '../../helpers/EditorHelper'
import AIannotator from './AIannotator'
import styles from './Annotator.module.scss'

/**
 * The user Annotator component has a textbox with a button for the history of the annotations for that image.
 * It should receive the history of the annotations.
 * And a function to save the annotation somewhere once the user types it.
 *
 * @param {{annotationList: List of Strings}} List of the annotations for this image
 * @returns The UserAnnotator component
 */
function UserAnnotator({ annotationList }) {
    const [typing, setTyping] = useState(false)
    const [textValue, setTextValue] = useState('')

    useEffect(() => {
        const list = annotationList
        if (list.length > 0) {
            // Display the latest human annotation
            setTextValue(list[list.length - 1])
        } else {
            // No img alt attribute
            setTextValue('')
        }
    }, [annotationList])

    return (
        <div className={styles.user_input}>
            <textarea
                value={textValue}
                onChange={(e) => {
                    setTextValue(e.target.value)
                }}
                placeholder="Your annotation here..."
                onFocus={() => {
                    setTyping(true)
                }}
                onBlur={() => {
                    setTyping(false)
                }}
            />
            <button
                type="button"
                className={
                    styles.icon + ' ' + (typing ? styles.transparent : '')
                }>
                <HistorySVG title="Annotation History" />
            </button>
        </div>
    )
}

UserAnnotator.propTypes = {
    annotationList: PropTypes.arrayOf(PropTypes.string).isRequired,
}

/**
 * Annotator component is meant to help the user produce an annotation for an image as an end result
 * It has an AI component for classifying images and generating AI descriptions
 * And a user component for letting the user annotate images
 *
 * @param {{currImage: ImageInfo}} props The props of the component
 * @param {{ebookId: The UUID for the ebook generated by server}} props The props of the component
 * @returns Tha Anotator Component
 */
function Annotator({ currImage, ebookId }) {
    const [userAnnotationList, setUserAnnotationList] = useState([])

    // Executed every time the currentImage changes
    useEffect(() => {
        const imgInfo = currImage
        if (imgInfo) {
            const altText = imgInfo.element.alt
            if (altText) {
                // Initial human annotation is the existing ALT-text
                setUserAnnotationList([altText])
            } else {
                // The image has no alt text
                setUserAnnotationList([])
            }
        }
    }, [currImage])

    return (
        <div className={styles.container}>
            <AIannotator currImage={currImage} ebookId={ebookId}>
                {' '}
            </AIannotator>
            <UserAnnotator annotationList={userAnnotationList} />
            <button type="button" className={styles.save_button}>
                Save Annotation
            </button>
        </div>
    )
}

Annotator.propTypes = {
    currImage: PropTypes.instanceOf(ImageInfo).isRequired,
    ebookId: PropTypes.string.isRequired,
}

export default Annotator
